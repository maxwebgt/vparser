# üõ†Ô∏è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –æ—á–∏—Å—Ç–∫–æ–π —Ä–µ—Å—É—Ä—Å–æ–≤

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–†–∞–Ω–µ–µ —Å–∫—Ä–∏–ø—Ç –ø–∞—Ä—Å–µ—Ä–∞ –∏–º–µ–ª –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏:

1. **Xvfb –ø—Ä–æ—Ü–µ—Å—Å** –æ—Å—Ç–∞–≤–∞–ª—Å—è –∑–∞–ø—É—â–µ–Ω–Ω—ã–º –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –¥–∏—Å–ø–ª–µ–π `:99`
2. **D-Bus –ø—Ä–æ—Ü–µ—Å—Å—ã** (system –∏ session) –Ω–µ –∑–∞–≤–µ—Ä—à–∞–ª–∏—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. **UPower daemon** –Ω–µ –æ—á–∏—â–∞–ª—Å—è –¥–æ–ª–∂–Ω—ã–º –æ–±—Ä–∞–∑–æ–º
4. **Lock —Ñ–∞–π–ª—ã X11** `/tmp/.X99-lock` –Ω–µ —É–¥–∞–ª—è–ª–∏—Å—å
5. **–ë—Ä–∞—É–∑–µ—Ä Puppeteer** –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª—Å—è –ø—Ä–∏ –∞–≤–∞—Ä–∏–π–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏

## ‚úÖ –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –û–±–Ω–æ–≤–ª–µ–Ω `start-parser.sh`

**–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `cleanup_resources()` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
- `signal_handler()` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è PID –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

**–£–ª—É—á—à–µ–Ω–∏—è:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ lock —Ñ–∞–π–ª–æ–≤ X11 –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º Xvfb
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ PID –≤—Å–µ—Ö –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- Graceful shutdown –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ SIGTERM/SIGINT
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–∞ EXIT –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ

### 2. –û–±–Ω–æ–≤–ª–µ–Ω `scraper.js`

**–î–æ–±–∞–≤–ª–µ–Ω—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤:**
- `gracefulShutdown()` - —Ñ—É–Ω–∫—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ SIGTERM, SIGINT, SIGQUIT
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π

**–£–ª—É—á—à–µ–Ω–∏—è:**
- –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `browser` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±—Ä–∞—É–∑–µ—Ä–∞
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ –ø—Ä–∏ –ª—é–±–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
- –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã –æ—á–∏—Å—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:

```bash
./test-cleanup.sh
```

**–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:**
1. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã –î–û –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞
2. –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–∞—Ä—Å–µ—Ä –≤ —Ñ–æ–Ω–µ
3. –ñ–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (15 —Å–µ–∫)
4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã –ü–û–°–õ–ï –∑–∞–ø—É—Å–∫–∞
5. –ó–∞–≤–µ—Ä—à–∞–µ—Ç –ø–∞—Ä—Å–µ—Ä —á–µ—Ä–µ–∑ SIGTERM
6. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ—á–∏—Å—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ù–æ—Ä–º–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
```bash
./start-parser.sh
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
```bash
./test-cleanup.sh
```

### –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)
```bash
# –û—á–∏—Å—Ç–∫–∞ Xvfb
sudo pkill -f "Xvfb.*:99"
sudo rm -f /tmp/.X99-lock /tmp/.X11-unix/X99

# –û—á–∏—Å—Ç–∫–∞ D-Bus
sudo pkill -f "dbus-daemon"
sudo rm -f /var/run/dbus/system_bus_socket /run/user/1000/bus

# –û—á–∏—Å—Ç–∫–∞ UPower
sudo pkill upowerd
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –≤ bash
```bash
trap signal_handler SIGTERM SIGINT EXIT
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –≤ Node.js
```javascript
process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));
process.on('SIGQUIT', () => gracefulShutdown('SIGQUIT'));
```

### –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- `XVFB_PID` - PID –ø—Ä–æ—Ü–µ—Å—Å–∞ Xvfb
- `DBUS_SYSTEM_PID` - PID system D-Bus daemon
- `DBUS_SESSION_PID` - PID session D-Bus daemon  
- `UPOWERD_PID` - PID UPower daemon
- `browser` - –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±—Ä–∞—É–∑–µ—Ä–∞

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–¢–∞–π–º-–∞—É—Ç—ã:** –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –æ—á–∏—Å—Ç–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç —Ä–∞–∑—É–º–Ω—ã–µ —Ç–∞–π–º-–∞—É—Ç—ã –¥–ª—è graceful shutdown
2. **Fallback:** –ï—Å–ª–∏ graceful shutdown –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (SIGKILL)
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ—á–∏—Å—Ç–∫–∏ –∏–º–µ—é—Ç –∑–∞—â–∏—Ç—É –æ—Ç –æ—à–∏–±–æ–∫ (`|| true`)
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–π —ç—Ç–∞–ø –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ Xvfb –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –¥–∏—Å–ø–ª–µ–π
- ‚úÖ D-Bus –ø—Ä–æ—Ü–µ—Å—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—á–∏—â–∞—é—Ç—Å—è
- ‚úÖ UPower daemon –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
- ‚úÖ Lock —Ñ–∞–π–ª—ã X11 —É–¥–∞–ª—è—é—Ç—Å—è
- ‚úÖ –ë—Ä–∞—É–∑–µ—Ä Puppeteer –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫ —Ç–∏–ø–∞:
```
Fatal server error:
(EE) Server is already active for display 99
``` 