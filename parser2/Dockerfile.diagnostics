# üê≥ Dockerfile –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
# –ë–∞–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞—Ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

ARG BASE_IMAGE=debian:12-slim

FROM ${BASE_IMAGE}

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    gnupg \
    lsb-release \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    bc \
    procps \
    iproute2 \
    dbus \
    systemd \
    sudo \
    xvfb \
    fonts-dejavu \
    fonts-liberation \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è parser
RUN useradd -m -s /bin/bash parser && \
    echo "parser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js 20.x
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Chrome
RUN wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add - && \
    echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list && \
    apt-get update && \
    apt-get install -y google-chrome-stable && \
    rm -rf /var/lib/apt/lists/*

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker CE (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Docker-in-Docker)
RUN curl -fsSL https://get.docker.com | sh || true

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UPower
RUN apt-get update && apt-get install -y upower && rm -rf /var/lib/apt/lists/*

# –ö–æ–ø–∏—Ä—É–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç
COPY system-diagnostics.sh /usr/local/bin/system-diagnostics.sh
RUN chmod +x /usr/local/bin/system-diagnostics.sh

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º D-Bus –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
RUN mkdir -p /run/user/1000 && \
    chown parser:parser /run/user/1000 && \
    chmod 700 /run/user/1000

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è parser
USER parser
WORKDIR /home/parser

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è D-Bus
ENV XDG_RUNTIME_DIR=/run/user/1000
ENV DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus

# –ö–æ–º–∞–Ω–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
CMD ["/usr/local/bin/system-diagnostics.sh"] 